---
title: On-Demand Service Architecture
owner: London Services
---
<!-- The below partial is in https://github.com/pivotal-cf/docs-partials -->
<%= partial vars.path_to_partials + "/services/deprecation-notice-eogs" %>

This topic describes the architecture for on-demand RabbitMQ&reg; for Pivotal Cloud Foundry (PCF).

For information about architecture of the older, pre-provisioned service, see [Deploying the RabbitMQÂ® Service](./deploying.html).

## <a id="service-network"></a>Service Network Requirement

When you deploy Pivotal Cloud Foundry, you must create a statically defined network to host the component virtual
machines that constitute the Pivotal Cloud Foundry infrastructure.

Pivotal Cloud Foundry components, like the Cloud Controller and UAA, run on this infrastructure network.
On-demand Pivotal Cloud Foundry services may require that you host them on a network that runs separately
from the Pivotal Cloud Foundry default network. You can also deploy tiles on separate service networks to
meet your own security requirement.

Pivotal Cloud Foundry v2.1 and later include dynamic networking. Operators can use this dynamic networking with
asynchronous service provisioning to define dynamically-provisioned service networks. For more
information, see [Default Network and Service Network](#on-demand).

In Pivotal Cloud Foundry v2.1 and later, on-demand services are enabled by default on all networks. Operators can
create separate networks to host services in BOSH Director, but doing so is optional.
Operators select which network hosts on-demand service instances when they configure the tile for
that service.

## <a id='on-demand'></a>Default Network and Service Network

On-demand Rabbit for PCF services rely on the BOSH 2.0 ability to dynamically deploy VMs in
a dedicated network.
The on-demand service broker uses this capability to create single-tenant service
instances in a dedicated service network.

On-demand services use the dynamically-provisioned service network to host the
single-tenant worker VMs that run as service instances within development spaces.
This architecture lets developers provision IaaS resources for their service
instances at creation time, rather than the operator pre-provisioning a fixed
quantity of IaaS resources when they deploy the service broker.

By making services single-tenant, where each instance runs on a dedicated VM
rather than sharing VMs with unrelated processes, on-demand services eliminate
the "noisy neighbor" problem when one app hogs resources on a shared cluster.
Single-tenant services can also support regulatory compliance where
sensitive data must be compartmentalized across separate machines.

An on-demand service splits its operations between the default network and the
service network.
Shared components of the service, such as executive controllers and databases,
run centrally on the default network along with the Cloud Controller, UAA, and
other Rabbit for PCF components.
The worker pool deployed to specific spaces runs on the service network.

The diagram below shows worker VMs in an on-demand service instance
running on a separate services network, while other components run on the default
network.

<img src="./images/odb-architecture.png">

## <a id="network-rules"></a> Required Networking Rules for On-Demand Services

Before deploying a service tile that uses the on-demand service broker (ODB),
request the needed network connections to allow components of Pivotal Cloud Foundry
to communicate with ODB.

The specifics of how to open those connections varies for each IaaS.

See the following table for key components and their responsibilities in an on-demand
architecture.

<table class="nice">
	<th>Key Components</th>
	<th>Their Responsibilities</th>
	<tr>
		<td><strong>BOSH Director</strong></td>
		<td>Creates and updates service instances as instructed by ODB.</td>
	</tr>
	<tr>
		<td><strong>BOSH Agent</strong></td>
		<td>Includes an agent on every VM that it deploys. The agent
 listens for instructions from the BOSH Director and carries out those instructions.
 The agent receives job specifications from the BOSH Director and uses them to assign
a role, or job, to the VM.</td>
	</tr>
	<tr>
		<td><strong>BOSH UAA</strong></td>
		<td>Issues OAuth2 tokens for clients to
use when they act on behalf of BOSH users.</td>
	</tr>
	<tr>
		<td><strong>PAS</strong></td>
		<td>Contains the apps that are consuming services</td>
	</tr>
	<tr>
		<td><strong>ODB</strong></td>
		<td>Instructs BOSH to create and update services, and connects
to services to create bindings.</td>
	</tr>
	<tr>
		<td><strong>Deployed service instance</strong></td>
		<td>Runs the given data service. For example, the deployed Redis for Pivotal Platform
			service instance runs the Redis for Pivotal Platform data service.</td>
	</tr>
</table>


<br>
Regardless of the specific network layout, the operator must ensure network
rules are set up so that connections are open as described in the table below.

<table class="nice">
	<th>Source Component</th>
	<th>Destination Component</th>
	<th>Default TCP Port</th>
	<th>Notes</th>
	<tr>
		<td><strong>ODB</strong></td>
		<td>
		    <strong>BOSH Director</strong><br><br>
		    <strong>BOSH UAA</strong>
		</td>
		<td>
				25555 (BOSH Director)<br><br>
				8443 (UAA)<br><br>
				8844 (CredHub)<br><br>
		</td>
		<td>The default ports are not configurable.</td>
	</tr>
	<tr>
		<td><strong>ODB</strong></td>
		<td><strong>Deployed service instances</strong>
		</td>
		<td>15672 (RabbitMQ Management UI)</td>
		<td>This connection is for administrative tasks.<br><br>
			Avoid opening general use, app-specific ports for this connection.</td>
	</tr>
	<tr>
		<td><strong>ODB</strong></td>
		<td><strong>PAS</strong>
		</td>
		<td>8443 (UAA)</td>
		<td>The default port is not configurable.</td>
	</tr>
	<tr>
		<td><strong>Errand VMs</strong></td>
		<td>
				<strong>PAS</strong><br><br>
				<strong>ODB</strong><br><br>
				<strong>Deployed Service Instances</strong><br><br>
		</td>
		<td>
				8443 (UAA)<br><br>
			  8080<br><br>
				15672 (RabbitMQ Management UI)<br><br>
				5672 (AMQP)<br><br>
				5671 (AMQPS)<br><br>
		</td>
		<td>The default port is not configurable.</td>
	</tr>
	<tr>
		<td><strong>BOSH Agent</strong></td>
		<td><strong>BOSH Director</strong>
		</td>
		<td>4222</td>
		<td>The BOSH Agent runs on every VM in the system, including the BOSH Director VM.<br><br>
			The BOSH Agent initiates the connection with the BOSH Director.<br><br>
			The default port is not configurable.<br><br>
			The communication between these components is two-way.</td>
	</tr>
	<tr>
		<td><strong>Deployed apps on PAS</strong></td>
		<td><strong>Deployed service instances</strong>
		</td>
		<td>
				15672 (RabbitMQ Management UI)<br><br>
				5672 (AMQP)<br><br>
				5671 (AMQPS)<br><br>
				61613 (STOMP)<br><br>
				61614 (STOMPS)<br><br>
				1883 (MQTT)<br><br>
				8883 (MQTTS)<br><br>
		</td>
		<td>This connection is for general use, app-specific tasks.<br><br>
			Avoid opening administrative ports for this connection.</td>
	</tr>
	<tr>
		<td><strong>PAS</strong></td>
		<td><strong>ODB</strong>
		</td>
		<td>8080</td>
		<td>This port may be different for individual services.<br><br>
			This port may also be configurable by the operator if allowed by the
			tile developer.</td>
	</tr>
		<tr>
		<td><strong>Deployed apps on PAS</strong></td>
		<td><strong>Runtime CredHub</strong>
		</td>
		<td>8844 (CredHub)</td>
		<td>This port is needed if secure service instance credentials are enabled.
		</td>
	</tr>
</table>
