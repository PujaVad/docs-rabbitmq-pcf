---
title: On-Demand Service Architecture
owner: London Services
---

This topic describes the architecture for on-demand RabbitMQ&reg; for Pivotal Cloud Foundry (PCF).

For information about architecture of the older, pre-provisioned service, see [Deploying the RabbitMQÂ® Service](./deploying.html).

## <a id="service-network"></a>Service Network Requirement

<%# The below partial is in https://github.com/pivotal-cf/docs-partials %>

When you deploy <%= vars.platform_old %>, you must create a statically defined network to host
the component VMs that make up the <%= vars.platform_old %> infrastructure.
<%= vars.platform_old %> components, such as Cloud Controller and UAA, run on this infrastructure network.

On-demand <%= vars.platform_old %> services might require you to host them on a separate network
from the <%= vars.platform_old %> default network.
You can also deploy on-demand services on a separate service networks to meet your own security requirements.

<%= vars.platform_old %> supports dynamic networking.
Operators can use dynamic networking with asynchronous service provisioning to define
dynamically-provisioned service networks.
For more information, see [Default Network and Service Network](#on-demand) below.

On-demand services are enabled by default on all networks.
Operators can optionally create separate networks to host services in BOSH Director.
Operators can select which network hosts on-demand service instances when they configure the tile for
that service.


## <a id='on-demand'></a>Default Network and Service Network

<%# The below partial is in https://github.com/pivotal-cf/docs-partials %>

On-demand <%= vars.product_short %> services use BOSH to dynamically deploy VMs and create single-tenant
service instances in a dedicated network.
On-demand services use the dynamically-provisioned service network to host single-tenant worker VMs.
These worker VMs run as service instances within development spaces.

This on-demand architecture has the following advantages:

+ Developers can provision IaaS resources for their services instances when the instances are created.
This removes the need for operators to pre-provision a fixed amount of IaaS resources
when they deploy the service broker.
+ Service instances run on a dedicated VM and do not share VMs with unrelated processes.
This removes the "noisy neighbor" problem, where an app monopolizes resources on a shared cluster.
+ Single-tenant services can support regulatory compliances where
sensitive data must be separated across different machines.

An on-demand service separates operations between the default network and the
service network. Shared service components, such as executive controllers and databases,
Cloud Controller, UAA, and other on-demand components, run on the default network.
Worker pools deployed to specific spaces run on the service network.


The diagram below shows worker VMs in an on-demand service instance
running on a separate services network, while other components run on the default
network.

<img src="/images/odb-architecture.png">

<a href="./images/odb-architecture.png" target="_blank">View a larger version of this image</a>



## <a id="network-rules"></a> Required Networking Rules for On-Demand Services

<%# The below partial is in https://github.com/pivotal-cf/docs-partials %>

Before deploying a service tile that uses the on-demand service broker (ODB),
you must create networking rules to enable <%= vars.platform_name %> components
to communicate with ODB. For instructions for creating networking rules,
see the documentation for your IaaS.

The following table lists key components and their responsibilities in the on-demand
architecture.

<table class="nice">
	<th>Key Components</th>
	<th>Component Responsibilities</th>
	<tr>
		<td><strong>BOSH Director</strong></td>
		<td>Creates and updates service instances as instructed by ODB.</td>
	</tr>
	<tr>
		<td><strong>BOSH Agent</strong></td>
		<td>Adds an agent on every VM that it deploys. The agent
 listens for instructions from the BOSH Director and executes those instructions.
 The agent receives job specifications from the BOSH Director and uses them to assign
a role or job to the VM.</td>
	</tr>
	<tr>
		<td><strong>BOSH UAA</strong></td>
		<td>Issues OAuth2 tokens for clients to use when they act on behalf of BOSH users.</td>
	</tr>
	<tr>
		<td><strong><%= vars.app_runtime_full %></strong></td>
		<td>Contains the apps that consume services.</td>
	</tr>
	<tr>
		<td><strong>ODB</strong></td>
		<td>Instructs BOSH to create and update services.
			 Connects to services to create bindings.</td>
	</tr>
	<tr>
		<td><strong>Deployed service instance</strong></td>
		<td>Runs the given service.
			For example, a deployed <%= vars.product_short %>
			service instance runs the <%= vars.product_short %> service.</td>
	</tr>
</table>

<br>
Regardless of the specific network layout, the operator must ensure network
rules are set up so that connections are open as described in the table below.

<table class="nice">
	<th>Source Component</th>
	<th>Destination Component</th>
	<th>Default TCP Port</th>
	<th>Notes</th>
	<tr>
		<td><strong>ODB</strong></td>
		<td>
		    <ul>
		        <li><strong>BOSH Director</strong></li>
		    	<li><strong>BOSH UAA</strong></li>
		    </ul>
		</td>
		<td>
			<ul>
				<li>25555</li>
				<li>8443</li>
			</ul>
		</td>
		<td>The default ports are not configurable.</td>
	</tr>
	<tr>
		<td><strong>ODB</strong></td>
		<td><strong>Deployed service instances</strong>
		</td>
		<td>15672 (RabbitMQ Management UI)</td>
		<td>This connection is for administrative tasks.
			Avoid opening general use, app-specific ports for this connection.</td>
	</tr>
	<tr>
		<td><strong>ODB</strong></td>
		<td><strong>PAS</strong>
		</td>
		<td>8443</td>
		<td>The default port is not configurable.</td>
	</tr>
	<tr>
		<td><strong>Errand VMs</strong></td>
		<td>
			<ul>
				<li><strong>PAS</strong></li>
				<li><strong>ODB</strong></li>
				<li><strong>Deployed Service Instances</strong></li>
			</ul>
		</td>
		<td>
			<ul>
				<li>8443</li>
				<li>8080</li>
				<li>15672 (RabbitMQ Management UI)</li>
				<li>5671-2 (AMQP/AMQPS)</li>
			</ul>
		</td>
		<td>The default port is not configurable.</td>
	</tr>
	<tr>
		<td><strong>BOSH Agent</strong></td>
		<td><strong>BOSH Director</strong>
		</td>
		<td>4222</td>
		<td>The BOSH Agent runs on every VM in the system, including the BOSH Director VM.
			The BOSH Agent initiates the connection with the BOSH Director.<br>
			The default port is not configurable.<br><br>
			The communication between these components is two-way.</td>
	</tr>
	<tr>
		<td><strong>Deployed apps on PAS</strong></td>
		<td><strong>Deployed service instances</strong>
		</td>
		<td>
			<ul>
				<li>15672 (RabbitMQ Management UI)</li>
				<li>5671-2 (AMQP/AMQPS)</li>
				<li>61613-4 (STOMP/STOMPS)</li>
				<li>1883, 8883 (MQTT/MQTTS)</li>
		</td>
		<td>This connection is for general use, app-specific tasks.
			Avoid opening administrative ports for this connection.</td>
	</tr>
	<tr>
		<td><strong>PAS</strong></td>
		<td><strong>ODB</strong>
		</td>
		<td>8080</td>
		<td>This port may be different for individual services.
			This port may also be configurable by the operator if allowed by the
			tile developer.</td>
	</tr>
		<tr>
		<td><strong>Deployed apps on PAS</strong></td>
		<td><strong>Runtime CredHub</strong>
		</td>
		<td>8844</td>
		<td>This port is needed if secure service instance credentials are enabled.<br>
			For information, see <a href="install-config.html#credhub">(Beta) On Demand - Secure Service Instance Credentials with Runtime CredHub</a>.</td>
	</tr>
</table>
