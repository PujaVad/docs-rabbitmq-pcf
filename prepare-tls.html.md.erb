---
title: Preparing for TLS
owner: RabbitMQ
---

This topic provides an overview of how to prepare for using Transport Layer Security (TLS) with the RabbitMQ on-demand service to secure
communication between apps and service instances.
The topic also includes the procedure
for providing an existing CA certificate to BOSH CredHub, or generating a new CA
certificate with BOSH CredHub.

<p class="note"><strong>Note</strong>: To enable TLS for RabbitMQ for PCF,
	you must perform the procedures in <a href="#provide-generate-pcf"> Provide or Generate a CA Certificate</a>
    below <strong>before</strong> installing and configuring the tile. This certificate is shared by multiple tiles.
    If you have already performed this procedure you do not need to repeat it.
    If you want to change this certificate, see <a href="rotating-ca.html">Rotating CA Certificates</a>.</p>


##<a id='overview'></a> Overview

Enabling TLS provisions a RabbitMQ server with a certificate so that apps and
clients can establish an encrypted connection with the data service.
This certificate is a **server certificate** generated by **CredHub**,
a component designed for centralized credential management in PCF,
colocated on the BOSH Director.

CredHub generates the server certificate with a **Certificate Authority (CA)**.
The operator can provide a certificate to CredHub or have CredHub generate a new certificate.

Apps and clients that communicate with the RabbitMQ server must have access to the public component of the CA certificate
in order to use the certificate and to validate that the server certificate can be trusted.

PCF distributes the public component of the CA certificate to apps in two ways:

* PCF provisions a copy of the CA certificate in the trusted store of each container's operating system.
  Apps written in Java and Spring automatically discover the CA certificate in the trusted store.
* PCF supplies the public CA certificate in an environment variable called `VCAP_SERVICES` that exists in every container.
  Apps not written in Java and Spring can retrieve the public component of the CA certificate from `VCAP_SERVICES`
  and use it to establish an encrypted connection with the data service.

##<a id='workflow'></a> Workflow for Enabling and Using TLS

The following workflow is required to enable TLS and to allow developers to use it with their apps:

<ol>
<li>An operator provides a CA certificate to CredHub by completing the procedures
    in <a href="#provide-generate-pcf">Provide or Generate a CA Certificate</a> below.</li>
<li>An operator enables TLS in the tile configuration while installing RabbitMQ for PCF.
    See <a href="install-config.html#security">Configure Security</a>.</li>
<li>A developer enables TLS for an existing service instance.
    See <a href="use.html#tls">Configure TLS for Your Service Instance</a>.</li>
<li>A developer modifies their app to communicate securely with the RabbitMQ server.
    See one of the following links, depending on the type of app:<br><br>
    <ul>
        <li>For Java or Spring apps: <a href="./use.html#tls-java-spring"> Activate TLS for Java and Spring Apps</a></li><br>
        <li>For other apps: <a href="./modify-apps-tls.html"> Modifying Apps for TLS</a></li>
    </ul>
</li>
</ol>

<p class="note"><strong>Note</strong>: An operator must also rotate the CA certificate if it expires or if it becomes compromised.
For information on how to rotate your CA certificate, see <a href="rotating-ca.html">Rotating CA Certificates</a>.</p>

##<a id="provide-generate-pcf"></a> Provide or Generate a CA Certificate

To enable and use TLS, you must complete the procedures below before installing and configuring the tile.

<p class="note warning"><strong>WARNING</strong>: This procedure requires restarting
all of the VMs in your PCF deployment in order to apply a CA certificate.
This operation can take a long time to complete.</p>


###<a id='uaa'></a> Create a UAA Client

Follow these steps to create a UAA client for CredHub on your UAA server:

1. Retrieve the IP address of the BOSH Director VM and the Director credentials by completing the steps
   in [Gather Credential and IP Address Information](https://docs.pivotal.io/pivotalcf/customizing/trouble-advanced.html#gather).<br><br>
   Both the UAA and CredHub servers are colocated on the BOSH Director VM.

1. SSH into the Ops Manager VM by completing the steps in [SSH into Ops Manager VM](https://docs.pivotal.io/pivotalcf/customizing/trouble-advanced.html#ssh).

1. From the Ops Manager VM, use the UAA Command Line Interface (UAAC) to target the UAA server on the BOSH Director VM.
    In the UAAC command, specify the IP address for the BOSH Director VM and port 8443.
    <br><br>
    Run the following command:

    ```
    uaac target BOSH-DIRECTOR:8443
    ```
    <br>
    Where `BOSH-DIRECTOR` is the IP address of the BOSH Director VM.
    You retrieved this address as part of the procedures in Step 1.
    <br><br>
    For example:
    <pre class="terminal">
    $ uaac target 10.0.0.5:8443
    </pre>

4. In the **Credentials** tab of the BOSH Director tile,
   retrieve and record the `identity` and `password` values for the following:
    + **Uaa Login Client Credentials**
    + **Uaa Admin User Credentials**

    <p class="note"><strong>Note</strong>: These are the credentials for the UAA server colocated on the BOSH Director,
     not the UAA server colocated on Pivotal Application Service.</p>

1. From the Ops Manager VM, use the UAAC to get a token.
    <br><br>
    Run the following command:

    ```
    uaac token owner get login --secret=UAA-LOGIN-CLIENT-CRED
    ```
    <br>
    Where `UAA-LOGIN-CLIENT-CRED` is the `password` value of the **Uaa Login Client Credentials**
    that you retrieved in Step 4 above.
    <br><br>
    For example:
    <pre class="terminal">
    $ uaac token owner get \
        login --secret=abcdefghijklm123456789
    </pre>

1. When prompted for a user name and password, enter the values for `identity` and `password` of the
**Uaa Admin User Credentials** you retrieved in step 5 above. <br><br>
    For example:
    <pre class="terminal">
    User name:  admin
    Password:  ********************************
    </pre>

1. Add a UAA client for CredHub with the correct grants.
    <br><br>
    Enter the following command:

    <pre class="terminal">
    $ uaac client add \
    	--authorized_grant_types client_credentials \
    	--authorities credhub.read,credhub.write
    </pre>

1. When prompted for Client ID, enter `credhub`.
   When prompted for `New client secret`, enter a secure password of your choice.
    For example:
    <pre class="terminal">
    Client ID:  credhub
    New client secret:  *******
    Verify new client secret:  *******
      scope: uaa.none
      client\_id: credhub
      resource\_ids: none
      authorized\_grant\_types: client\_credentials
      autoapprove:
      authorities: credhub.write credhub.read
      name: credhub
      required_user_groups:
      lastmodified: 1518198701452
      id: credhub
      created_by: f609e861-39ec-4a16-8aee-cba9e9b079e3
    </pre>

###<a id='add-ca-cert'></a> Add the CA Certificate

Follow these steps to log in to CredHub, provide or generate a CA certificate, and add the certificate to Ops Manager:

1. From the Ops Manager VM, set the API target of the CredHub CLI to your CredHub server.
    <br><br>
    Run the following command:

    ```
    credhub api https://BOSH-DIRECTOR:8844 --ca-cert=/var/tempest/workspaces/default/root_ca_certificate
    ```
    <br>
    Where `BOSH-DIRECTOR` is the IP address of the BOSH Director VM.
    <br><br>
    For example:
    <pre class="terminal">
    $ credhub api http<span>s:</span>//10.0.0.5:8844 --ca-cert=/var/tempest/workspaces/default/root_ca_certificate
    </pre>

1. Log in to CredHub.
    <br><br>
    Run the following command:

    ```
    credhub login --client-name=credhub --client-secret=CLIENT-SECRET
    ```
    <br>
    Where `CLIENT-SECRET` is the `New client secret` you set in step 8 in the procedure above.
    <br><br>
    For example:
    <pre class="terminal">
    $ credhub login \
    	--client-name=credhub \
    	--client-secret=abcdefghijklm123456789
    </pre>
1. Use the CredHub CLI to check whether a services CA certificate already is present.
    <br><br>
	* Enter the following command:
  	<pre class="terminal">
  	$ credhub get \
  		  --name="/services/tls_ca"
  	</pre>
  * If you already have a certificate at the `services/tls_ca` path, skip to step 5.

1. Use the CredHub CLI to generate a CA certificate or provide an existing one.
    <p class="note"><strong>Note</strong>: Your PCF deployment may have multiple CA certificates.
       Pivotal recommends a dedicated CA certificate for services.</p>
	* If you do not have a CA certificate, use the CredHub CLI to generate one.
          Enter the following command:
		<pre class="terminal">
		$ credhub generate \
			--name="/services/tls_ca" \
			--type="certificate" \
			--no-overwrite \
			--is-ca \
            --common-name="rootCA"
		</pre>
    * If you have an existing CA certificate that you want to use,
      create a new file called `root.pem` with the contents of the certificate.
      Then enter the following command, specifying the path to `root.pem`
      and the private key for the certificate.
      For example:
        <pre class="terminal">
        $ credhub set \
            --name="/services/tls_ca" \
            --type="certificate" \
            --certificate=./root.pem \
            --private=ERKSOSMFF...
        </pre>

1. Use the BOSH CLI v2 to extract the `certificate` portion from the CA certificate and print it.
    Run the following command:

    <pre class="terminal">
    $ bosh int <(credhub get \
    --name=/services/tls_ca) \
    --path /value/certificate
    </pre>
1. Copy the output.
1. Navigate to the Ops Manager **Installation Dashboard** and select the BOSH Director tile.
Click **Security**.
1. Paste the contents of the CA certificate into **Trusted Certificates**, and then click **Save**.
1. After preparing your environment for TLS, you must enable TLS in the tile configuration,
   following the appropriate step below.
    <p class="note warning"><strong>WARNING</strong>: Restarting all of the VMs in your PCF deployment in order to apply a
    CA certificate takes a long time to complete.</p>
    * **For an Existing Installation**: Complete the steps in
    [Configure Security](install-config.html#security) to enable TLS in the tile,
    click **Review Pending Changes**, and then click **Apply Changes** in the Installation Dashboard.
    This restarts all the VMs in your PCF deployment and applies your CA certificate.
    <p class="note"><strong>Note:</strong>
    Make sure the <code>upgrade-all-service-instances</code> errand is set to <strong>On</strong>.
    This errand must be run to ensure all service instances have the needed changes. </p>
    * **For a New Installation**: Complete the procedures in
    [Installing and Configuring RabbitMQ for PCF](install-config.html),
    including enabling TLS in the **Security for On-Demand Plans** tab, 
    click **Review Pending Changes**, and then click **Apply Changes**
    in the Installation Dashboard.
    This deploys RabbitMQ for PCF, restarts all the VMs in your PCF deployment, and applies your CA certificate.
